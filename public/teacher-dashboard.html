<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard - School Management</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .permission-badge {
      display: inline-block;
      padding: 5px 12px;
      margin: 3px;
      border-radius: 20px;
      font-size: 12px;
      background: #667eea;
      color: white;
    }
    .role-admin { background: #e74c3c; }
    .role-head_teacher { background: #f39c12; }
    .role-teacher { background: #27ae60; }
    .access-denied {
      background: #fee;
      border: 2px solid #e74c3c;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      color: #c0392b;
    }
    .feature-card {
      border: 1px solid #eee;
      padding: 20px;
      border-radius: 10px;
      margin: 10px 0;
    }
    .feature-card.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo">Teacher Portal</div>
    <div class="nav-links">
      <a href="/teacher-dashboard.html">Dashboard</a>
      <a href="/teacher-students.html">Manage Students</a>
      <a href="/teacher-manage.html">Manage Teachers</a>
      <a href="/teacher-login.html" onclick="logout()">Logout</a>
    </div>
  </nav>

  <div class="container">
    <div class="card">
      <div class="card-header">Teacher Profile</div>
      <div id="profile-info">
        <p><strong>Name:</strong> <span id="teacher-name">-</span></p>
        <p><strong>Email:</strong> <span id="teacher-email">-</span></p>
        <p><strong>Subject:</strong> <span id="teacher-subject">-</span></p>
        <p><strong>Role:</strong> <span id="teacher-role" class="permission-badge">-</span></p>
        <p><strong>Permissions:</strong></p>
        <div id="teacher-permissions"></div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="total-students">0</div>
        <div class="stat-label">Total Students</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-teachers">0</div>
        <div class="stat-label">Total Teachers</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="my-classes">0</div>
        <div class="stat-label">My Classes</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Features by Permission</div>
      
      <div class="feature-card" id="feature-view">
        <h4>View Students</h4>
        <p>Permission: <code>view_students</code></p>
        <button class="btn btn-primary" onclick="viewStudents()">View All Students</button>
      </div>

      <div class="feature-card" id="feature-edit">
        <h4>Edit Students</h4>
        <p>Permission: <code>edit_students</code></p>
        <button class="btn btn-success" onclick="window.location.href='/teacher-students.html'">Edit Students</button>
      </div>

      <div class="feature-card" id="feature-delete">
        <h4>Delete Students</h4>
        <p>Permission: <code>delete_students</code></p>
        <button class="btn btn-danger" onclick="window.location.href='/teacher-students.html'">Manage & Delete</button>
      </div>

      <div class="feature-card" id="feature-grades">
        <h4>Manage Grades</h4>
        <p>Permission: <code>manage_grades</code></p>
        <button class="btn btn-primary" onclick="alert('Grade management feature')">Manage Grades</button>
      </div>

      <div class="feature-card" id="feature-teachers">
        <h4>Manage Teachers</h4>
        <p>Permission: <code>manage_teachers</code> (Admin only)</p>
        <button class="btn btn-danger" onclick="window.location.href='/teacher-manage.html'">Manage Teachers</button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Privilege Escalation Demo</div>
      <div class="vuln-warning">
        <h4>VULNERABLE: Add Permission Without Authorization</h4>
        <p>API endpoint allows adding permissions without proper authorization check</p>
      </div>
      <div class="form-group">
        <label>Select Permission to Add:</label>
        <select id="new-permission">
          <option value="view_students">view_students</option>
          <option value="edit_students">edit_students</option>
          <option value="delete_students">delete_students</option>
          <option value="manage_grades">manage_grades</option>
          <option value="manage_teachers">manage_teachers</option>
          <option value="full_access">full_access</option>
        </select>
      </div>
      <button class="btn btn-danger" onclick="escalatePrivilege()">Escalate Privilege (Add Permission)</button>
      <div id="escalate-result" style="margin-top: 10px;"></div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    let currentTeacher = null;
    let permissions = [];

    document.addEventListener('DOMContentLoaded', () => {
      loadTeacherData();
      loadStats();
      checkPermissions();
    });

    function loadTeacherData() {
      const teacherData = localStorage.getItem('teacher');
      if (!teacherData) {
        window.location.href = '/teacher-login.html';
        return;
      }

      currentTeacher = JSON.parse(teacherData);
      permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
      const role = localStorage.getItem('role') || 'teacher';

      document.getElementById('teacher-name').textContent = currentTeacher.name;
      document.getElementById('teacher-email').textContent = currentTeacher.email;
      document.getElementById('teacher-subject').textContent = currentTeacher.subject || '-';
      
      const roleEl = document.getElementById('teacher-role');
      roleEl.textContent = role;
      roleEl.className = `permission-badge role-${role}`;

      const permEl = document.getElementById('teacher-permissions');
      permEl.innerHTML = permissions.map(p => 
        `<span class="permission-badge">${p}</span>`
      ).join('') || '<span style="color:#888">No permissions</span>';
    }

    async function loadStats() {
      try {
        const students = await fetchAPI('/api/students');
        const teachers = await fetchAPI('/api/teachers');
        
        document.getElementById('total-students').textContent = students.length;
        document.getElementById('total-teachers').textContent = teachers.length;
        document.getElementById('my-classes').textContent = currentTeacher?.classes?.length || 0;
      } catch (err) {
        console.error(err);
      }
    }

    function checkPermissions() {
      const role = localStorage.getItem('role');
      const hasFullAccess = role === 'admin' || permissions.includes('full_access');

      // View students
      if (!hasFullAccess && !permissions.includes('view_students')) {
        document.getElementById('feature-view').classList.add('disabled');
      }

      // Edit students
      if (!hasFullAccess && !permissions.includes('edit_students')) {
        document.getElementById('feature-edit').classList.add('disabled');
      }

      // Delete students
      if (!hasFullAccess && !permissions.includes('delete_students')) {
        document.getElementById('feature-delete').classList.add('disabled');
      }

      // Manage grades
      if (!hasFullAccess && !permissions.includes('manage_grades')) {
        document.getElementById('feature-grades').classList.add('disabled');
      }

      // Manage teachers (admin only)
      if (role !== 'admin' && !permissions.includes('manage_teachers') && !hasFullAccess) {
        document.getElementById('feature-teachers').classList.add('disabled');
      }
    }

    async function viewStudents() {
      try {
        const students = await fetchAPI('/api/students');
        alert(`Found ${students.length} students:\n${students.map(s => s.name).join('\n')}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function escalatePrivilege() {
      if (!currentTeacher) return;
      
      const permission = document.getElementById('new-permission').value;
      try {
        const result = await fetchAPI(`/api/teachers/${currentTeacher._id}/permissions`, 'POST', { permission });
        document.getElementById('escalate-result').innerHTML = 
          `<div class="alert alert-success">Permission "${permission}" added! Refresh to see changes.</div>`;
        
        // Update local storage
        if (!permissions.includes(permission)) {
          permissions.push(permission);
          localStorage.setItem('permissions', JSON.stringify(permissions));
        }
        
        // Reload UI
        loadTeacherData();
        checkPermissions();
      } catch (err) {
        document.getElementById('escalate-result').innerHTML = 
          `<div class="alert alert-danger">Error: ${err.message}</div>`;
      }
    }

    function logout() {
      localStorage.removeItem('teacher');
      localStorage.removeItem('permissions');
      localStorage.removeItem('role');
    }
  </script>
</body>
</html>
